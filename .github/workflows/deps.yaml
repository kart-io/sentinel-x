# 依赖更新检查
# 触发条件: 每周一 UTC 时间 00:00

name: Dependency Update

on:
  schedule:
    - cron: '0 0 * * 1'
  workflow_dispatch:

jobs:
  update:
    name: Check Dependencies
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'
          cache: true

      - name: Check for updates
        id: check
        run: |
          go list -u -m -json all | jq -r 'select(.Update) | "\(.Path): \(.Version) -> \(.Update.Version)"' > updates.txt
          if [ -s updates.txt ]; then
            echo "has_updates=true" >> $GITHUB_OUTPUT
            echo "## 可用更新" >> $GITHUB_STEP_SUMMARY
            cat updates.txt >> $GITHUB_STEP_SUMMARY
          else
            echo "has_updates=false" >> $GITHUB_OUTPUT
            echo "所有依赖均为最新版本" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Update dependencies
        if: steps.check.outputs.has_updates == 'true'
        run: |
          go get -u ./...
          go mod tidy

      - name: Create Pull Request
        if: steps.check.outputs.has_updates == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'chore(deps): 更新 Go 依赖'
          title: 'chore(deps): 自动更新 Go 依赖'
          body: |
            ## 依赖更新

            本 PR 由 GitHub Actions 自动创建，包含以下依赖更新：

            ```
            $(cat updates.txt)
            ```

            请在合并前验证所有测试通过。
          branch: deps/auto-update
          delete-branch: true
          labels: |
            dependencies
            automated
