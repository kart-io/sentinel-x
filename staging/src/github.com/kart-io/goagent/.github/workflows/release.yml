name: Release

on:
  push:
    tags:
      - 'v*.*.*'  # Triggers on version tags like v1.0.0, v2.1.3, etc.

permissions:
  contents: write

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'

      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: |
            ~/go/pkg/mod
            ~/.cache/go-build
          key: ${{ runner.os }}-go-1.23-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-1.23-

      - name: Download dependencies
        run: go mod download

      - name: Run tests
        run: go test -v -timeout 10m ./...

      - name: Verify import layering
        run: |
          chmod +x ./scripts/verify_imports.sh
          ./scripts/verify_imports.sh

      - name: Verify library can be imported
        run: |
          echo "Verifying library import..."
          go list -m github.com/kart-io/goagent

          # Check that major packages compile
          go build -v ./core/...
          go build -v ./llm/...
          go build -v ./tools/...
          go build -v ./agents/...

          echo "âœ… Library verification complete"

      - name: Build example binaries (optional)
        env:
          VERSION: ${{ github.ref_name }}
          COMMIT: ${{ github.sha }}
        run: |
          mkdir -p dist

          # Build plugingen CLI tool
          BUILD_DATE=$(date -u +%Y-%m-%dT%H:%M:%SZ)
          LDFLAGS="-s -w -X main.Version=${VERSION} -X main.GitCommit=${COMMIT} -X main.BuildDate=${BUILD_DATE}"
          PKG_PATH="./tools/plugingen/cmd/plugingen"

          # Linux AMD64
          GOOS=linux GOARCH=amd64 go build -ldflags="${LDFLAGS}" -o dist/plugingen-linux-amd64 ${PKG_PATH}
          tar -czf dist/plugingen-${VERSION}-linux-amd64.tar.gz -C dist plugingen-linux-amd64

          # Linux ARM64
          GOOS=linux GOARCH=arm64 go build -ldflags="${LDFLAGS}" -o dist/plugingen-linux-arm64 ${PKG_PATH}
          tar -czf dist/plugingen-${VERSION}-linux-arm64.tar.gz -C dist plugingen-linux-arm64

          # macOS AMD64
          GOOS=darwin GOARCH=amd64 go build -ldflags="${LDFLAGS}" -o dist/plugingen-darwin-amd64 ${PKG_PATH}
          tar -czf dist/plugingen-${VERSION}-darwin-amd64.tar.gz -C dist plugingen-darwin-amd64

          # macOS ARM64 (Apple Silicon)
          GOOS=darwin GOARCH=arm64 go build -ldflags="${LDFLAGS}" -o dist/plugingen-darwin-arm64 ${PKG_PATH}
          tar -czf dist/plugingen-${VERSION}-darwin-arm64.tar.gz -C dist plugingen-darwin-arm64

          # Windows AMD64
          GOOS=windows GOARCH=amd64 go build -ldflags="${LDFLAGS}" -o dist/plugingen-windows-amd64.exe ${PKG_PATH}
          zip -j dist/plugingen-${VERSION}-windows-amd64.zip dist/plugingen-windows-amd64.exe

      - name: Generate checksums
        run: |
          cd dist
          if ls *.tar.gz *.zip 1> /dev/null 2>&1; then
            sha256sum *.tar.gz *.zip > checksums.txt
            cat checksums.txt
          else
            echo "No binaries to checksum (library project)" > checksums.txt
          fi

      - name: Extract release notes
        id: extract-release-notes
        run: |
          # Try to extract release notes from CHANGELOG.md if it exists
          if [ -f "CHANGELOG.md" ]; then
            # Extract notes for current version
            awk '/^## \[${{ github.ref_name }}\]/{flag=1; next} /^## \[/{flag=0} flag' CHANGELOG.md > release_notes.md

            # If no specific notes found, use a default message
            if [ ! -s release_notes.md ]; then
              echo "Release ${{ github.ref_name }}" > release_notes.md
              echo "" >> release_notes.md
              echo "See [CHANGELOG.md](CHANGELOG.md) for details." >> release_notes.md
            fi
          else
            # Create default release notes
            echo "Release ${{ github.ref_name }}" > release_notes.md
            echo "" >> release_notes.md
            echo "## What's Changed" >> release_notes.md
            echo "" >> release_notes.md
            echo "This release includes:" >> release_notes.md
            echo "- Bug fixes and improvements" >> release_notes.md
            echo "- Enhanced reasoning pattern implementations" >> release_notes.md
            echo "" >> release_notes.md
            echo "**Full Changelog**: https://github.com/${{ github.repository }}/compare/$(git describe --tags --abbrev=0 HEAD^)...${{ github.ref_name }}" >> release_notes.md
          fi

          cat release_notes.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: Release ${{ github.ref_name }}
          body_path: release_notes.md
          draft: false
          prerelease: ${{ contains(github.ref_name, '-alpha') || contains(github.ref_name, '-beta') || contains(github.ref_name, '-rc') }}
          files: |
            dist/*.tar.gz
            dist/*.zip
            dist/checksums.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Publish to Go pkg
        run: |
          echo "Publishing to pkg.go.dev..."
          # The package will be automatically indexed by pkg.go.dev when the tag is pushed
          GOPROXY=proxy.golang.org go list -m github.com/kart-io/goagent@${{ github.ref_name }}
