name: Nightly Build

on:
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  nightly:
    name: Nightly Build and Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'
          cache: true

      - name: Download dependencies
        run: go mod download

      # --- æ–°å¢æ­¥éª¤ï¼šå®‰è£… gotestsum ---
      - name: Install gotestsum
        run: go install gotest.tools/gotestsum@latest

      # --- ä¿®æ”¹æ­¥éª¤ï¼šä½¿ç”¨ gotestsum è¿è¡Œæµ‹è¯•ï¼ˆå¢åŠ é‡è¯•å’Œå¹¶å‘æ§åˆ¶ï¼‰---
      - name: Run all tests
        run: |
          # gotestsum å‚æ•°è¯´æ˜ï¼š
          # --format testname: ç®€æ´è¾“å‡º
          # --junitfile: ç”Ÿæˆ XML æŠ¥å‘Š
          # --rerun-fails: å¤±è´¥æµ‹è¯•è‡ªåŠ¨é‡è¯•ï¼ˆæœ€å¤š2æ¬¡ï¼‰
          # --rerun-fails-max-failures: æœ€å¤šé‡è¯•10ä¸ªå¤±è´¥æµ‹è¯•
          # --packages: æ˜¾å¼æŒ‡å®šåŒ…åˆ—è¡¨ï¼ˆ--rerun-fails å¿…éœ€ï¼‰
          #
          # go test å‚æ•°è¯´æ˜ï¼š
          # -race: ç«æ€æ£€æµ‹
          # -timeout 30m: æ€»è¶…æ—¶æ—¶é—´å»¶é•¿åˆ°30åˆ†é’Ÿ
          # -parallel 4: é™åˆ¶å¹¶è¡Œæµ‹è¯•æ•°é‡ï¼Œé¿å…èµ„æºç«äº‰
          # -count 1: ç¦ç”¨æµ‹è¯•ç¼“å­˜ï¼Œç¡®ä¿æ¯æ¬¡éƒ½æ‰§è¡Œ
          gotestsum \
            --format testname \
            --junitfile unit-tests.xml \
            --rerun-fails \
            --rerun-fails-max-failures 10 \
            --packages="./..." \
            -- \
            -race \
            -timeout 30m \
            -parallel 4 \
            -count 1 \
            ./...
        env:
          GO_TEST_MODE: "true"
          # å¢åŠ  Go è¿è¡Œæ—¶é…ç½®ï¼Œæé«˜å¹¶å‘ç¨³å®šæ€§
          GOMAXPROCS: "4"
          # å¯ç”¨ CGO ä»¥æ”¯æŒ SQLite æµ‹è¯•å’Œ Race æ£€æµ‹
          CGO_ENABLED: "1"

      - name: Run benchmarks
        run: |
          go test -bench=. -benchmem -run=^$ ./... > benchmark_results.txt
          cat benchmark_results.txt

      - name: Upload benchmark results
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results-${{ github.sha }}
          path: benchmark_results.txt

      - name: Check for dependency updates
        run: |
          go list -u -m all > dependency_updates.txt
          if grep -q '\[' dependency_updates.txt; then
            echo "::warning::Dependencies have updates available"
            cat dependency_updates.txt
          fi

      - name: Upload coverage report
        if: hashFiles('coverage.out') != ''
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report-${{ github.sha }}
          path: coverage.out

      # --- æ–°å¢æ­¥éª¤ï¼šä¸Šä¼ æµ‹è¯•ç»“æœ XML (å³ä½¿å¤±è´¥ä¹Ÿä¸Šä¼ ) ---
      - name: Upload test results
        if: always() # ç¡®ä¿å³ä½¿æµ‹è¯•å¤±è´¥ä¹Ÿèƒ½æ‹¿åˆ°æŠ¥å‘Š
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ github.sha }}
          path: unit-tests.xml

      - name: Notify on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            const existingIssues = await github.rest.issues.listForRepo({
              owner,
              repo,
              labels: 'nightly-failure',
              state: 'open'
            });

            const runUrl = `${context.serverUrl}/${owner}/${repo}/actions/runs/${context.runId}`;

            if (existingIssues.data.length > 0) {
              const issueNumber = existingIssues.data[0].number;
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: issueNumber,
                body:
                  'ğŸ”„ åˆä¸€æ¬¡æ„å»ºå¤±è´¥\n\n' +
                  `æäº¤: ${context.sha}\n` +
                  `å·¥ä½œæµè¿è¡Œ: ${runUrl}\n` +
                  `æ—¶é—´: ${new Date().toISOString()}`
              });
            } else {
              await github.rest.issues.create({
                owner,
                repo,
                title: 'âŒ Nightly Build Failed',
                body:
                  `Nightly build failed for commit ${context.sha}\n\n` +
                  `å·¥ä½œæµè¿è¡Œ: ${runUrl}\n\n` +
                  'è¯·è°ƒæŸ¥å¹¶ä¿®å¤é—®é¢˜ã€‚',
                labels: ['ci', 'nightly-failure']
              });
            }

      - name: Close issue on success
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            const openIssues = await github.rest.issues.listForRepo({
              owner,
              repo,
              labels: 'nightly-failure',
              state: 'open'
            });

            const runUrl = `${context.serverUrl}/${owner}/${repo}/actions/runs/${context.runId}`;

            for (const issue of openIssues.data) {
              await github.rest.issues.update({
                owner,
                repo,
                issue_number: issue.number,
                state: 'closed'
              });

              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: issue.number,
                body:
                  'âœ… é—®é¢˜å·²ä¿®å¤\n\n' +
                  `Nightly Build åœ¨æäº¤ ${context.sha} ä¸ŠæˆåŠŸé€šè¿‡ã€‚\n` +
                  `å·¥ä½œæµè¿è¡Œ: ${runUrl}`
              });
            }