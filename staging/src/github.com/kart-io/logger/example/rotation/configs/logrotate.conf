# Logrotate 配置示例
# 将此文件放置到 /etc/logrotate.d/myapp

# 基本配置示例
/var/log/myapp/*.log {
    # 轮转频率：daily, weekly, monthly
    daily
    
    # 保留的轮转文件数量（对应 15 天）
    rotate 15
    
    # 如果日志文件不存在，不报错
    missingok
    
    # 如果日志文件为空，不进行轮转
    notifempty
    
    # 压缩旧的日志文件（节省磁盘空间）
    compress
    
    # 延迟压缩，即下一次轮转时才压缩前一个文件
    # 这样可以避免应用仍在写入时压缩文件
    delaycompress
    
    # 创建新日志文件时的权限设置
    # 格式：权限 用户 组
    create 0644 myapp myapp
    
    # 轮转后执行的脚本
    postrotate
        # 向应用发送 USR1 信号，让应用重新打开日志文件
        # 需要应用实现信号处理
        if [ -f /var/run/myapp.pid ]; then
            /bin/kill -USR1 $(cat /var/run/myapp.pid) 2>/dev/null || true
        fi
        
        # 或者使用 systemd 重启服务（如果适用）
        # /bin/systemctl reload myapp 2>/dev/null || true
    endscript
}

# 高级配置示例：不同日志级别不同策略
/var/log/myapp/error.log {
    daily
    rotate 30          # 错误日志保留更长时间
    missingok
    notifempty
    compress
    delaycompress
    create 0644 myapp myapp
    
    # 当文件超过 100MB 时也会触发轮转
    size 100M
    
    postrotate
        /bin/kill -USR1 $(cat /var/run/myapp.pid) 2>/dev/null || true
    endscript
}

/var/log/myapp/access.log {
    daily
    rotate 7           # 访问日志保留较短时间
    missingok
    notifempty
    compress
    delaycompress
    create 0644 myapp myapp
    
    # 访问日志可以较大，500MB 触发轮转
    size 500M
    
    postrotate
        /bin/kill -USR1 $(cat /var/run/myapp.pid) 2>/dev/null || true
    endscript
}

# 高频应用配置：按小时轮转
/var/log/myapp/high-frequency.log {
    hourly
    rotate 168         # 7天 * 24小时 = 168个文件
    missingok
    notifempty
    compress
    delaycompress
    create 0644 myapp myapp
    
    # 即使按小时轮转，也设置大小限制防止单个文件过大
    size 200M
    
    postrotate
        /bin/kill -USR1 $(cat /var/run/myapp.pid) 2>/dev/null || true
    endscript
}

# 审计日志配置：长期保留，不压缩
/var/log/myapp/audit.log {
    monthly
    rotate 12          # 保留 12 个月
    missingok
    notifempty
    
    # 审计日志不压缩，便于合规检查
    nocompress
    
    create 0640 myapp audit
    
    # 审计日志轮转后可能需要特殊处理
    postrotate
        # 发送到审计系统或备份
        if [ -f /usr/local/bin/audit-backup.sh ]; then
            /usr/local/bin/audit-backup.sh "$1" 2>/dev/null || true
        fi
        
        /bin/kill -USR1 $(cat /var/run/myapp.pid) 2>/dev/null || true
    endscript
}