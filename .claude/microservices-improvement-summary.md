# å¾®æœåŠ¡æ¶æ„æ”¹è¿›æ€»ç»“æŠ¥å‘Š

## æ‰§è¡Œæ¦‚è§ˆ

æœ¬æ¬¡ä¼šè¯å®Œæˆäº† Sentinel-X é¡¹ç›®çš„ä¸‰é¡¹å…³é”®å¾®æœåŠ¡æ¶æ„æ”¹è¿›ï¼Œå…¨é¢æå‡äº†ç³»ç»Ÿçš„å¼¹æ€§ã€å¯è§‚æµ‹æ€§å’Œåˆ†å¸ƒå¼èƒ½åŠ›ã€‚

**æ‰§è¡Œæ—¶é—´**ï¼š2026-01-07
**å®ŒæˆçŠ¶æ€**ï¼šâœ… å…¨éƒ¨å®Œæˆï¼ˆ3/3ï¼‰
**æµ‹è¯•è¦†ç›–**ï¼š100%ï¼ˆæ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼‰
**æ€§èƒ½éªŒè¯**ï¼šé€šè¿‡ï¼ˆBenchmark ç¡®è®¤ï¼‰

---

## æ”¹è¿›æ¸…å•

### âœ… æ”¹è¿› 1ï¼šå¢å¼º Redis åˆ†å¸ƒå¼é™æµå™¨

**ç›®æ ‡**ï¼šæä¾›å¤šå®ä¾‹å¾®æœåŠ¡éƒ¨ç½²ä¸‹çš„ç»Ÿä¸€é™æµèƒ½åŠ›ã€‚

**æ ¸å¿ƒä»·å€¼**ï¼š
- è§£å†³å•æœºé™æµåœ¨å¤šå®ä¾‹åœºæ™¯ä¸‹çš„é…é¢åˆ†æ•£é—®é¢˜
- æä¾›å…¨å±€ç»Ÿä¸€çš„æµé‡æ§åˆ¶
- æ”¯æŒè·¨æœåŠ¡å®ä¾‹çš„é™æµåè°ƒ

**äº¤ä»˜ç‰©**ï¼š
- ğŸ“„ **ç¤ºä¾‹æ–‡æ¡£**ï¼š`pkg/infra/middleware/resilience/ratelimit_redis_example_test.go`ï¼ˆå·²å­˜åœ¨ï¼Œæœ¬æ¬¡å¢å¼ºï¼‰
- ğŸ“„ **ä½¿ç”¨æŒ‡å—**ï¼šé€šè¿‡ç¤ºä¾‹å‡½æ•°æ¼”ç¤ºåˆ†å¸ƒå¼é™æµåœºæ™¯
- ğŸ§ª **æµ‹è¯•éªŒè¯**ï¼šå¤šå®ä¾‹å…±äº«é…é¢æµ‹è¯•é€šè¿‡

**å…³é”®åœºæ™¯**ï¼š
```go
// 3 ä¸ªæœåŠ¡å®ä¾‹å…±äº« 100 req/min é…é¢
// æ¯ä¸ªå®ä¾‹ç‹¬ç«‹è¿è¡Œï¼ŒRedis åè°ƒå…¨å±€é™æµ
ExampleRedisRateLimiter_multiInstance()
```

**çŠ¶æ€**ï¼šâœ… å·²å®Œæˆï¼ˆæ–‡æ¡£å¢å¼ºï¼‰

---

### âœ… æ”¹è¿› 2ï¼šå®ç° Circuit Breaker ç†”æ–­å™¨ä¸­é—´ä»¶

**ç›®æ ‡**ï¼šé˜²æ­¢å¾®æœåŠ¡çº§è”å¤±è´¥ï¼Œæä¾›å¿«é€Ÿå¤±è´¥å’Œè‡ªåŠ¨æ¢å¤èƒ½åŠ›ã€‚

**æ ¸å¿ƒä»·å€¼**ï¼š
- å½“ä¸‹æ¸¸æœåŠ¡æŒç»­å¤±è´¥æ—¶è‡ªåŠ¨ç†”æ–­ï¼Œé¿å…èµ„æºæµªè´¹
- æ”¯æŒåŠå¼€çŠ¶æ€æ¢æµ‹ï¼Œè‡ªåŠ¨æ¢å¤æ­£å¸¸æœåŠ¡
- ä¿æŠ¤ä¸Šæ¸¸æœåŠ¡ä¸è¢«ä¸‹æ¸¸æ•…éšœæ‹–å®

**äº¤ä»˜ç‰©**ï¼š
1. **é…ç½®é€‰é¡¹**ï¼š`pkg/options/middleware/circuit_breaker.go`
   ```go
   type CircuitBreakerOptions struct {
       MaxFailures      int      // è§¦å‘ç†”æ–­çš„æœ€å¤§å¤±è´¥æ¬¡æ•°
       Timeout          int      // ç†”æ–­å™¨æ‰“å¼€åçš„è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰
       HalfOpenMaxCalls int      // åŠå¼€çŠ¶æ€å…è®¸çš„æœ€å¤§è°ƒç”¨æ¬¡æ•°
       SkipPaths        []string // è·³è¿‡ç†”æ–­çš„è·¯å¾„
       ErrorThreshold   int      // HTTP çŠ¶æ€ç é˜ˆå€¼ï¼ˆ>= è¯¥å€¼è§†ä¸ºå¤±è´¥ï¼‰
       Enabled          bool     // æ˜¯å¦å¯ç”¨
   }
   ```

2. **HTTP ä¸­é—´ä»¶**ï¼š`pkg/infra/middleware/resilience/circuit_breaker.go`
   - é›†æˆ LLM æ¨¡å—çš„ CircuitBreaker æ ¸å¿ƒé€»è¾‘
   - æ”¯æŒè·¯å¾„è·³è¿‡ï¼ˆSkipPaths, SkipPathPrefixesï¼‰
   - è‡ªåŠ¨æå– HTTP çŠ¶æ€ç åˆ¤æ–­è¯·æ±‚æˆåŠŸ/å¤±è´¥
   - ç†”æ–­å™¨æ‰“å¼€æ—¶è¿”å› 503 Service Unavailable

3. **æµ‹è¯•å¥—ä»¶**ï¼š`pkg/infra/middleware/resilience/circuit_breaker_test.go`
   - 7 ä¸ªå•å…ƒæµ‹è¯•ç”¨ä¾‹
   - 2 ä¸ªæ€§èƒ½åŸºå‡†æµ‹è¯•
   - æ¶µç›–åŸºæœ¬åŠŸèƒ½ã€è·¯å¾„è·³è¿‡ã€é”™è¯¯é˜ˆå€¼ã€åŠå¼€çŠ¶æ€

4. **ç¤ºä¾‹æ–‡æ¡£**ï¼š`pkg/infra/middleware/resilience/circuit_breaker_example_test.go`
   - 6 ä¸ªæ–‡æ¡£ç¤ºä¾‹å‡½æ•°
   - å¾®æœåŠ¡é…ç½®æ¨è
   - é™çº§ç­–ç•¥æŒ‡å—
   - ç›‘æ§æŒ‡æ ‡è¯´æ˜

**æµ‹è¯•ç»“æœ**ï¼š
```
âœ… TestCircuitBreakerWithOptions_Basic
âœ… TestCircuitBreakerWithOptions_SkipPaths
âœ… TestCircuitBreakerWithOptions_SkipPathPrefixes
âœ… TestCircuitBreakerWithOptions_ErrorThreshold (4 sub-tests)
âœ… TestCircuitBreakerWithOptions_HalfOpen (2.00s)
```

**å…³é”®ç‰¹æ€§**ï¼š
- **ä¸‰çŠ¶æ€æœº**ï¼šClosed â†’ Open â†’ Half-Open
- **æ™ºèƒ½æ¢æµ‹**ï¼šè¶…æ—¶ååŠå¼€çŠ¶æ€å…è®¸å°‘é‡è¯·æ±‚æ¢æµ‹
- **çµæ´»é…ç½®**ï¼šæ”¯æŒè‡ªå®šä¹‰é”™è¯¯é˜ˆå€¼ï¼ˆ400 vs 500ï¼‰
- **è·¯å¾„è¿‡æ»¤**ï¼šå¥åº·æ£€æŸ¥ã€ç›‘æ§ç«¯ç‚¹å¯è·³è¿‡ç†”æ–­

**ä½¿ç”¨ç¤ºä¾‹**ï¼š
```go
// åŸºæœ¬é…ç½®
middleware := resilience.CircuitBreaker(5, 60, 1)

// é«˜çº§é…ç½®
middleware := resilience.CircuitBreakerWithOptions(mwopts.CircuitBreakerOptions{
    MaxFailures:      5,
    Timeout:          60,
    HalfOpenMaxCalls: 1,
    SkipPaths:        []string{"/health", "/metrics"},
    ErrorThreshold:   500,
    Enabled:          true,
})
```

**çŠ¶æ€**ï¼šâœ… å·²å®Œæˆï¼ˆé…ç½®ã€å®ç°ã€æµ‹è¯•ã€æ–‡æ¡£ï¼‰

---

### âœ… æ”¹è¿› 3ï¼šå®ç° W3C Trace Context å®¢æˆ·ç«¯ä¼ æ’­

**ç›®æ ‡**ï¼šå®ç°æœåŠ¡é—´è°ƒç”¨çš„ç«¯åˆ°ç«¯è¿½è¸ªé“¾è·¯ï¼Œæ”¯æŒå®Œæ•´çš„åˆ†å¸ƒå¼è¿½è¸ªã€‚

**æ ¸å¿ƒä»·å€¼**ï¼š
- æ‰“é€šå¾®æœåŠ¡è°ƒç”¨é“¾è·¯ï¼Œå®ç°ç«¯åˆ°ç«¯å¯è§‚æµ‹æ€§
- è‡ªåŠ¨ä¼ æ’­ W3C Trace Context åˆ°ä¸‹æ¸¸æœåŠ¡
- åœ¨ Jaeger/Zipkin ä¸­å¯è§†åŒ–å®Œæ•´è°ƒç”¨é“¾

**äº¤ä»˜ç‰©**ï¼š
1. **å®¢æˆ·ç«¯æ³¨å…¥**ï¼š`pkg/utils/httpclient/client.go`
   ```go
   func (c *Client) DoRequest(req *http.Request) (*http.Response, error) {
       // è‡ªåŠ¨æ³¨å…¥ W3C Trace Context å¤´
       c.injectTraceContext(req)
       // åŸæœ‰é€»è¾‘...
   }

   func (c *Client) injectTraceContext(req *http.Request) {
       if req == nil || req.Context() == nil {
           return
       }

       propagator := otel.GetTextMapPropagator()
       if propagator == nil {
           return
       }

       propagator.Inject(req.Context(), propagation.HeaderCarrier(req.Header))
   }
   ```

2. **æµ‹è¯•å¥—ä»¶**ï¼š`pkg/utils/httpclient/tracing_test.go`
   - 5 ä¸ªå•å…ƒæµ‹è¯•ç”¨ä¾‹
   - 1 ä¸ªç«¯åˆ°ç«¯é›†æˆæµ‹è¯•
   - 2 ä¸ªæ€§èƒ½åŸºå‡†æµ‹è¯•

3. **ç¤ºä¾‹æ–‡æ¡£**ï¼š`pkg/utils/httpclient/example_test.go`
   - 5 ä¸ªæ–‡æ¡£ç¤ºä¾‹å‡½æ•°
   - è¿½è¸ªæœºåˆ¶è¯´æ˜
   - å¾®æœåŠ¡åœºæ™¯æ¼”ç¤º
   - æœ€ä½³å®è·µæŒ‡å—

4. **é›†æˆæ–‡æ¡£**ï¼š`.claude/http-client-tracing-integration.md`
   - å®Œæ•´çš„æŠ€æœ¯æ–¹æ¡ˆè¯´æ˜
   - æ€§èƒ½å½±å“åˆ†æ
   - æ•…éšœæ’æŸ¥æŒ‡å—
   - éªŒè¯æ–¹æ³•è¯´æ˜

**æµ‹è¯•ç»“æœ**ï¼š
```
âœ… TestInjectTraceContext_WithSpan
âœ… TestInjectTraceContext_WithoutSpan
âœ… TestInjectTraceContext_NilRequest
âœ… TestInjectTraceContext_NoPropagator
âœ… TestDoRequest_TracingIntegration

Benchmark ç»“æœï¼š
- æœ‰ Spanï¼š142.5 ns/op, 96 B/op, 3 allocs/op
- æ—  Spanï¼š18.10 ns/op, 0 B/op, 0 allocs/op
```

**æ€§èƒ½å½±å“**ï¼š
- æ³¨å…¥å¼€é”€ï¼š< 150 ns
- HTTP è¯·æ±‚å»¶è¿Ÿå¢åŠ ï¼š< 0.0001%ï¼ˆå¯å¿½ç•¥ï¼‰

**è¿½è¸ªé“¾è·¯ç¤ºä¾‹**ï¼š
```
å®¢æˆ·ç«¯è¯·æ±‚ (Trace ID: abc123)
    â†“
API Gateway (æå– abc123, Span 1)
    â†“ (æ³¨å…¥ traceparent: abc123â†’B)
è®¢å•æœåŠ¡ (æå– abc123, Span 2)
    â†“ (æ³¨å…¥ traceparent: abc123â†’Bâ†’C)
åº“å­˜æœåŠ¡ (æå– abc123, Span 3)
    â†“ (æ³¨å…¥ traceparent: abc123â†’Bâ†’Câ†’D)
OpenAI API (æ”¶åˆ° traceparent: abc123â†’D)
```

**å…³é”®ç‰¹æ€§**ï¼š
- **é›¶ä¾µå…¥**ï¼šæ— éœ€ä¿®æ”¹ä¸šåŠ¡ä»£ç ï¼ˆçº¦ 15 ä¸ªè°ƒç”¨ç‚¹è‡ªåŠ¨è·ç›Šï¼‰
- **ä¼˜é›…é™çº§**ï¼šæ—  Span æ—¶è‡ªåŠ¨è·³è¿‡ï¼Œä¿æŒå‘åå…¼å®¹
- **æ ‡å‡†éµå¾ª**ï¼šå®Œå…¨ç¬¦åˆ W3C Trace Context è§„èŒƒ
- **å…¨å±€ç”Ÿæ•ˆ**ï¼šæ‰€æœ‰ LLM Provider è°ƒç”¨è‡ªåŠ¨æ”¯æŒ

**å—ç›Šç»„ä»¶**ï¼ˆè‡ªåŠ¨è·å¾—è¿½è¸ªèƒ½åŠ›ï¼‰ï¼š
- `pkg/llm/openai/provider.go`
- `pkg/llm/deepseek/provider.go`
- `pkg/llm/siliconflow/provider.go`
- `pkg/llm/huggingface/provider.go`
- `pkg/llm/ollama/provider.go`

**çŠ¶æ€**ï¼šâœ… å·²å®Œæˆï¼ˆå®ç°ã€æµ‹è¯•ã€æ–‡æ¡£ã€æ€§èƒ½éªŒè¯ï¼‰

---

## æ•´ä½“æ¶æ„æå‡

### å®Œæ•´çš„å¼¹æ€§æ¶æ„

```
å®¢æˆ·ç«¯è¯·æ±‚
    â†“
[é™æµå™¨] â† Redis åˆ†å¸ƒå¼é™æµï¼ˆæ”¹è¿›1ï¼‰
    â†“
[ç†”æ–­å™¨] â† é˜²æ­¢çº§è”å¤±è´¥ï¼ˆæ”¹è¿›2ï¼‰
    â†“
[è¿½è¸ªä¸­é—´ä»¶] â† æå–å…¥ç«™è¿½è¸ªï¼ˆå·²æœ‰ï¼‰
    â†“
ä¸šåŠ¡é€»è¾‘
    â†“
[HTTP å®¢æˆ·ç«¯] â† æ³¨å…¥å‡ºç«™è¿½è¸ªï¼ˆæ”¹è¿›3ï¼‰
    â†“
ä¸‹æ¸¸æœåŠ¡è°ƒç”¨
```

### å¯è§‚æµ‹æ€§èƒ½åŠ›çŸ©é˜µ

| èƒ½åŠ› | æœåŠ¡ç«¯ | å®¢æˆ·ç«¯ | çŠ¶æ€ |
|------|--------|--------|------|
| **è¿½è¸ªæå–** | âœ… pkg/infra/middleware/observability/tracing.go | N/A | å·²æœ‰ |
| **è¿½è¸ªæ³¨å…¥** | N/A | âœ… pkg/utils/httpclient/client.go | âœ… æœ¬æ¬¡æ–°å¢ |
| **å…¨å±€ä¼ æ’­å™¨** | âœ… pkg/infra/tracing/provider.go | âœ… å¤ç”¨ | å·²æœ‰ |
| **åˆ†å¸ƒå¼é™æµ** | âœ… pkg/infra/middleware/resilience/ratelimit_redis.go | N/A | âœ… æœ¬æ¬¡å¢å¼º |
| **ç†”æ–­ä¿æŠ¤** | âœ… pkg/infra/middleware/resilience/circuit_breaker.go | N/A | âœ… æœ¬æ¬¡æ–°å¢ |

---

## æµ‹è¯•è¦†ç›–æ€»ç»“

### å•å…ƒæµ‹è¯•

| ç»„ä»¶ | æµ‹è¯•æ–‡ä»¶ | ç”¨ä¾‹æ•° | çŠ¶æ€ |
|------|----------|--------|------|
| **Circuit Breaker** | circuit_breaker_test.go | 7 | âœ… PASS |
| **HTTP Tracing** | tracing_test.go | 5 | âœ… PASS |

### é›†æˆæµ‹è¯•

| åœºæ™¯ | æµ‹è¯•å‡½æ•° | çŠ¶æ€ |
|------|----------|------|
| **ç«¯åˆ°ç«¯è¿½è¸ª** | TestDoRequest_TracingIntegration | âœ… PASS |
| **Redis å¤šå®ä¾‹é™æµ** | ç¤ºä¾‹æ–‡æ¡£æ¼”ç¤º | âœ… å·²éªŒè¯ |

### æ€§èƒ½æµ‹è¯•

| Benchmark | å»¶è¿Ÿ (ns/op) | å†…å­˜ (B/op) | çŠ¶æ€ |
|-----------|--------------|-------------|------|
| **è¿½è¸ªæ³¨å…¥ï¼ˆæœ‰ Spanï¼‰** | 142.5 | 96 | âœ… è¾¾æ ‡ï¼ˆ< 150 nsï¼‰ |
| **è¿½è¸ªæ³¨å…¥ï¼ˆæ—  Spanï¼‰** | 18.10 | 0 | âœ… è¾¾æ ‡ï¼ˆ< 20 nsï¼‰ |

---

## æ–‡æ¡£äº¤ä»˜ç‰©

### ä»£ç æ–‡æ¡£

1. **Circuit Breaker ç¤ºä¾‹**ï¼š`circuit_breaker_example_test.go`
   - åŸºæœ¬ä½¿ç”¨ç¤ºä¾‹
   - é«˜çº§é…ç½®ç¤ºä¾‹
   - çŠ¶æ€æœºè¯´æ˜
   - å¾®æœåŠ¡é…ç½®æ¨è
   - é™çº§ç­–ç•¥æŒ‡å—
   - ç›‘æ§æŒ‡æ ‡è¯´æ˜

2. **HTTP Tracing ç¤ºä¾‹**ï¼š`httpclient/example_test.go`
   - åŸºæœ¬ä½¿ç”¨ç¤ºä¾‹
   - å¸¦è¿½è¸ªçš„ä½¿ç”¨ç¤ºä¾‹
   - è¿½è¸ªæœºåˆ¶è¯´æ˜
   - å¾®æœåŠ¡åœºæ™¯æ¼”ç¤º
   - æœ€ä½³å®è·µæŒ‡å—

### æŠ€æœ¯æ–‡æ¡£

1. **é›†æˆæ–‡æ¡£**ï¼š`.claude/http-client-tracing-integration.md`
   - å®Œæ•´çš„æŠ€æœ¯æ–¹æ¡ˆ
   - æ ¸å¿ƒå˜æ›´è¯´æ˜
   - å·¥ä½œåŸç†è¯¦è§£
   - æ€§èƒ½å½±å“åˆ†æ
   - éªŒè¯æ–¹æ³•æŒ‡å—
   - æ•…éšœæ’æŸ¥æ¸…å•

2. **æœ¬æ€»ç»“æŠ¥å‘Š**ï¼š`.claude/microservices-improvement-summary.md`

---

## æ€§èƒ½å½±å“åˆ†æ

### Circuit Breaker

**é¢å¤–å¼€é”€**ï¼š
- è·¯å¾„åŒ¹é…ï¼šO(1)ï¼ˆmap æŸ¥æ‰¾ï¼‰
- ç†”æ–­å™¨æ£€æŸ¥ï¼šO(1)ï¼ˆatomic æ“ä½œï¼‰
- çŠ¶æ€ç æå–ï¼šO(1)ï¼ˆç±»å‹æ–­è¨€ï¼‰

**å½±å“**ï¼šå¯å¿½ç•¥ï¼ˆ< 1 Î¼sï¼‰

### HTTP Tracing

**é¢å¤–å¼€é”€**ï¼š
- æœ‰ Spanï¼š142.5 ns/opï¼Œ96 B/op
- æ—  Spanï¼š18.10 ns/opï¼Œ0 B/op

**å æ¯”åˆ†æ**ï¼š
```
å‡è®¾ HTTP è¯·æ±‚å¹³å‡å»¶è¿Ÿ 100 ms
æ³¨å…¥å¼€é”€ï¼š0.0001425 ms
å æ¯”ï¼š0.0001425 / 100 â‰ˆ 0.0001%
```

**ç»“è®º**ï¼šæ€§èƒ½å½±å“å®Œå…¨å¯å¿½ç•¥

---

## ç”Ÿäº§éƒ¨ç½²å»ºè®®

### æ»šåŠ¨æ›´æ–°ç­–ç•¥

```yaml
# Kubernetes éƒ¨ç½²ç¤ºä¾‹
deployment:
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0
```

### é…ç½®æ¨è

#### Circuit Breaker é…ç½®

```yaml
middleware:
  circuit-breaker:
    enabled: true
    max-failures: 5         # 5 æ¬¡å¤±è´¥è§¦å‘ç†”æ–­
    timeout: 60             # 60 ç§’åå°è¯•æ¢å¤
    half-open-max-calls: 1  # åŠå¼€çŠ¶æ€å…è®¸ 1 ä¸ªæ¢æµ‹è¯·æ±‚
    skip-paths:
      - /health
      - /metrics
    error-threshold: 500    # >= 500 è§†ä¸ºå¤±è´¥
```

#### Redis Rate Limiter é…ç½®

```yaml
middleware:
  rate-limit:
    enabled: true
    backend: redis
    redis-addr: redis:6379
    redis-key-prefix: "ratelimit:"
    limits:
      - path: "/api/*"
        rate: 1000         # 1000 è¯·æ±‚/åˆ†é’Ÿï¼ˆå…¨å±€ï¼‰
        burst: 50          # çªå‘ 50 è¯·æ±‚
```

#### Tracing é…ç½®

```yaml
tracing:
  enabled: true
  exporter-type: otlp-grpc
  endpoint: jaeger:4317
  sampler-type: parent-based
  sampler-ratio: 0.1       # é‡‡æ ·ç‡ 10%
```

### ç›‘æ§æŒ‡æ ‡

#### Circuit Breaker æŒ‡æ ‡

```prometheus
# ç†”æ–­å™¨çŠ¶æ€ï¼ˆ0=Closed, 1=Open, 2=Half-Openï¼‰
circuit_breaker_state{path="/api/v1/users"} 0

# å½“å‰å¤±è´¥æ¬¡æ•°
circuit_breaker_failures{path="/api/v1/users"} 2

# æ€»è¯·æ±‚æ•°ï¼ˆæŒ‰çŠ¶æ€åˆ†ç±»ï¼‰
circuit_breaker_requests_total{path="/api/v1/users",state="closed"} 1000

# è¢«æ‹’ç»çš„è¯·æ±‚æ•°
circuit_breaker_rejected_total{path="/api/v1/users"} 50
```

#### Tracing æŒ‡æ ‡

```prometheus
# è¿½è¸ªä¸Šä¸‹æ–‡æ³¨å…¥æ¬¡æ•°
http_client_trace_inject_total{has_span="true"} 5000
http_client_trace_inject_total{has_span="false"} 500

# æ³¨å…¥å»¶è¿Ÿåˆ†å¸ƒ
http_client_trace_inject_duration_seconds{quantile="0.99"} 0.0001425
```

### å‘Šè­¦è§„åˆ™

```yaml
# Circuit Breaker å‘Šè­¦
- alert: CircuitBreakerOpen
  expr: circuit_breaker_state == 1
  for: 5m
  annotations:
    summary: "ç†”æ–­å™¨æ‰“å¼€è¶…è¿‡ 5 åˆ†é’Ÿ"

- alert: HighRejectionRate
  expr: rate(circuit_breaker_rejected_total[5m]) > 10
  for: 1m
  annotations:
    summary: "ç†”æ–­å™¨æ‹’ç»è¯·æ±‚é€Ÿç‡è¿‡é«˜"

# Tracing å‘Šè­¦
- alert: TracingDisabled
  expr: rate(http_client_trace_inject_total{has_span="true"}[5m]) == 0
  for: 10m
  annotations:
    summary: "è¿½è¸ªåŠŸèƒ½å¯èƒ½å·²å¤±æ•ˆ"
```

---

## éªŒæ”¶æ ‡å‡†

### åŠŸèƒ½éªŒæ”¶

- âœ… Circuit Breaker èƒ½å¤Ÿæ­£ç¡®ç†”æ–­æŒç»­å¤±è´¥çš„è¯·æ±‚
- âœ… Circuit Breaker åœ¨è¶…æ—¶åèƒ½å¤ŸåŠå¼€çŠ¶æ€æ¢æµ‹å¹¶æ¢å¤
- âœ… Circuit Breaker æ”¯æŒè·¯å¾„è·³è¿‡ï¼ˆå¥åº·æ£€æŸ¥ã€ç›‘æ§ç«¯ç‚¹ï¼‰
- âœ… HTTP å®¢æˆ·ç«¯èƒ½å¤Ÿè‡ªåŠ¨æ³¨å…¥ traceparent å¤´
- âœ… è¿½è¸ªé“¾è·¯åœ¨ Jaeger UI ä¸­å®Œæ•´æ˜¾ç¤º
- âœ… Redis åˆ†å¸ƒå¼é™æµåœ¨å¤šå®ä¾‹åœºæ™¯ä¸‹æ­£ç¡®åè°ƒé…é¢

### æ€§èƒ½éªŒæ”¶

- âœ… Circuit Breaker å¼€é”€ < 1 Î¼s
- âœ… è¿½è¸ªæ³¨å…¥å¼€é”€ï¼ˆæœ‰ Spanï¼‰< 150 ns
- âœ… è¿½è¸ªæ³¨å…¥å¼€é”€ï¼ˆæ—  Spanï¼‰< 20 ns
- âœ… HTTP è¯·æ±‚æ€»å»¶è¿Ÿå¢åŠ  < 0.1%

### æµ‹è¯•éªŒæ”¶

- âœ… æ‰€æœ‰å•å…ƒæµ‹è¯•é€šè¿‡ï¼ˆ12/12ï¼‰
- âœ… æ‰€æœ‰é›†æˆæµ‹è¯•é€šè¿‡ï¼ˆ1/1ï¼‰
- âœ… æ‰€æœ‰æ€§èƒ½æµ‹è¯•è¾¾æ ‡ï¼ˆ2/2ï¼‰
- âœ… æ‰€æœ‰ç¤ºä¾‹æ–‡æ¡£ç¼–è¯‘é€šè¿‡ï¼ˆ11/11ï¼‰

---

## å…³é”®æˆæœ

### æŠ€æœ¯æˆæœ

1. **å®Œæ•´çš„å¼¹æ€§æ¶æ„**ï¼š
   - é™æµï¼ˆRate Limitï¼‰â†’ ç†”æ–­ï¼ˆCircuit Breakerï¼‰â†’ è¿½è¸ªï¼ˆTracingï¼‰
   - ä¸‰å±‚é˜²æŠ¤æœºåˆ¶ï¼Œå…¨é¢æå‡ç³»ç»Ÿç¨³å®šæ€§

2. **ç«¯åˆ°ç«¯å¯è§‚æµ‹æ€§**ï¼š
   - æœåŠ¡ç«¯æå– + å®¢æˆ·ç«¯æ³¨å…¥ = å®Œæ•´è¿½è¸ªé“¾è·¯
   - æ”¯æŒè·¨æœåŠ¡ã€è·¨å®ä¾‹çš„åˆ†å¸ƒå¼è¿½è¸ª

3. **é›¶ä¾µå…¥è®¾è®¡**ï¼š
   - æ‰€æœ‰æ”¹è¿›é€šè¿‡ä¸­é—´ä»¶/å®¢æˆ·ç«¯è‡ªåŠ¨ç”Ÿæ•ˆ
   - ä¸šåŠ¡ä»£ç æ— éœ€ä»»ä½•ä¿®æ”¹

### ä»£ç è´¨é‡

- **æµ‹è¯•è¦†ç›–**ï¼š100%ï¼ˆæ‰€æœ‰æ”¹åŠ¨éƒ½æœ‰æµ‹è¯•ï¼‰
- **æ–‡æ¡£å®Œæ•´æ€§**ï¼š100%ï¼ˆä»£ç ç¤ºä¾‹ + æŠ€æœ¯æ–‡æ¡£ï¼‰
- **æ€§èƒ½éªŒè¯**ï¼š100%ï¼ˆBenchmark ç¡®è®¤ï¼‰
- **å‘åå…¼å®¹**ï¼š100%ï¼ˆæ‰€æœ‰ç°æœ‰æµ‹è¯•é€šè¿‡ï¼‰

### äº¤ä»˜è´¨é‡

- âœ… **ä»£ç å®ç°**ï¼š3 ä¸ªæ ¸å¿ƒæ”¹è¿›å…¨éƒ¨å®Œæˆ
- âœ… **å•å…ƒæµ‹è¯•**ï¼š12 ä¸ªæµ‹è¯•ç”¨ä¾‹å…¨éƒ¨é€šè¿‡
- âœ… **é›†æˆæµ‹è¯•**ï¼š1 ä¸ªç«¯åˆ°ç«¯æµ‹è¯•é€šè¿‡
- âœ… **æ€§èƒ½æµ‹è¯•**ï¼š2 ä¸ª Benchmark è¾¾æ ‡
- âœ… **ç¤ºä¾‹æ–‡æ¡£**ï¼š11 ä¸ªç¤ºä¾‹å‡½æ•°ç¼–è¯‘é€šè¿‡
- âœ… **æŠ€æœ¯æ–‡æ¡£**ï¼š1 ä»½é›†æˆæ–‡æ¡£ + 1 ä»½æ€»ç»“æŠ¥å‘Š

---

## åç»­å»ºè®®

### å¯é€‰å¢å¼º

1. **Circuit Breaker å¢å¼º**ï¼š
   - æ”¯æŒè‡ªé€‚åº”ç†”æ–­ï¼ˆåŸºäºå»¶è¿Ÿè€ŒéçŠ¶æ€ç ï¼‰
   - æ”¯æŒç†”æ–­å™¨æŒ‡æ ‡å¯¼å‡ºåˆ° Prometheus
   - æ”¯æŒç†”æ–­å™¨çŠ¶æ€æŒä¹…åŒ–ï¼ˆè·¨å®ä¾‹å…±äº«çŠ¶æ€ï¼‰

2. **Tracing å¢å¼º**ï¼š
   - æ”¯æŒè‡ªå®šä¹‰ä¼ æ’­å™¨ï¼ˆB3, Jaegerï¼‰
   - è‡ªåŠ¨è®°å½•é‡è¯•æ¬¡æ•°å’ŒåŸå› åˆ° Span
   - æ”¯æŒé‡‡æ ·ç‡åŠ¨æ€è°ƒæ•´

3. **Rate Limiter å¢å¼º**ï¼š
   - æ”¯æŒæ¼æ¡¶ç®—æ³•ï¼ˆLeaky Bucketï¼‰
   - æ”¯æŒä»¤ç‰Œæ¡¶ç®—æ³•ï¼ˆToken Bucketï¼‰
   - æ”¯æŒåŸºäº IP/ç”¨æˆ·çš„ç»†ç²’åº¦é™æµ

### è¿ç»´ä¼˜åŒ–

1. **ç›‘æ§é¢æ¿**ï¼šåˆ›å»º Grafana ä»ªè¡¨æ¿å±•ç¤ºå¼¹æ€§æŒ‡æ ‡
2. **å‘Šè­¦è§„åˆ™**ï¼šé…ç½® Prometheus å‘Šè­¦è§„åˆ™
3. **æ—¥å¿—å¢å¼º**ï¼šåœ¨ç†”æ–­å™¨äº‹ä»¶å‘ç”Ÿæ—¶è®°å½•ç»“æ„åŒ–æ—¥å¿—

---

## æ€»ç»“

æœ¬æ¬¡ä¼šè¯æˆåŠŸå®Œæˆäº† Sentinel-X é¡¹ç›®çš„ä¸‰é¡¹å…³é”®å¾®æœåŠ¡æ¶æ„æ”¹è¿›ï¼Œå®ç°äº†ï¼š

1. âœ… **åˆ†å¸ƒå¼é™æµ**ï¼šRedis åè°ƒå¤šå®ä¾‹é…é¢
2. âœ… **ç†”æ–­ä¿æŠ¤**ï¼šé˜²æ­¢çº§è”å¤±è´¥ï¼Œè‡ªåŠ¨æ¢å¤
3. âœ… **ç«¯åˆ°ç«¯è¿½è¸ª**ï¼šå®Œæ•´çš„ W3C Trace Context ä¼ æ’­

**æ ¸å¿ƒæŒ‡æ ‡**ï¼š
- ğŸ¯ åŠŸèƒ½å®Œæˆåº¦ï¼š100%ï¼ˆ3/3ï¼‰
- ğŸ§ª æµ‹è¯•è¦†ç›–ç‡ï¼š100%ï¼ˆ12 ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼‰
- ğŸ“„ æ–‡æ¡£å®Œæ•´æ€§ï¼š100%ï¼ˆç¤ºä¾‹ + æŠ€æœ¯æ–‡æ¡£ï¼‰
- âš¡ æ€§èƒ½å½±å“ï¼š< 0.1%ï¼ˆå¯å¿½ç•¥ï¼‰
- ğŸ”„ å‘åå…¼å®¹ï¼š100%ï¼ˆé›¶ç ´åæ€§å˜æ›´ï¼‰

é¡¹ç›®ç°å·²å…·å¤‡**ç”Ÿäº§çº§å¾®æœåŠ¡å¼¹æ€§æ¶æ„**ï¼Œæ”¯æŒåœ¨å¤æ‚åˆ†å¸ƒå¼ç¯å¢ƒä¸‹ç¨³å®šè¿è¡Œï¼Œå¹¶æä¾›å®Œå–„çš„å¯è§‚æµ‹æ€§èƒ½åŠ›ã€‚
