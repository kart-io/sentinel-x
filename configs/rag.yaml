# Sentinel-X RAG Service Configuration
# RAG 知识库服务配置文件

# Server configuration
server:
  # Server mode: http, grpc, or both
  mode: http
  # Graceful shutdown timeout
  shutdown-timeout: 30s

  # HTTP server configuration
  http:
    # Listen address
    addr: ":8082"
    # Read timeout
    read-timeout: 60s
    # Write timeout (longer for RAG queries)
    write-timeout: 120s
    # Idle timeout
    idle-timeout: 60s
    # HTTP framework adapter: gin or echo
    adapter: gin

    # Middleware configuration
    middleware:
      # Recovery middleware (panic recovery)
      disable-recovery: false
      recovery:
        enable-stack-trace: false

      # Request ID middleware
      disable-request-id: false
      request-id:
        header: X-Request-ID

      # Logger middleware
      disable-logger: false
      logger:
        skip-paths:
          - /health
          - /live
          - /ready
          - /metrics
        use-structured-logger: true

      # CORS middleware
      disable-cors: false
      cors:
        allow-origins:
          - "*"
        allow-methods:
          - GET
          - POST
          - PUT
          - DELETE
          - OPTIONS
        allow-headers:
          - Origin
          - Content-Type
          - Accept
          - Authorization
          - X-Request-ID
        allow-credentials: false
        max-age: 86400

      # Timeout middleware (disabled for long RAG operations)
      disable-timeout: true

      # Health check endpoints
      disable-health: false
      health:
        path: /health
        liveness-path: /live
        readiness-path: /ready

      # Metrics endpoint
      disable-metrics: false
      metrics:
        path: /metrics
        namespace: sentinel
        subsystem: rag

      # Pprof endpoints (disabled by default for security)
      disable-pprof: true

      # Authentication middleware (disabled for RAG service)
      disable-auth: true

      # Authorization middleware
      disable-authz: true

  # gRPC server configuration (optional)
  grpc:
    addr: ":8102"
    timeout: 30s
    max-recv-msg-size: 4194304
    max-send-msg-size: 4194304
    enable-reflection: true

# Logger configuration
log:
  level: info
  format: json
  output-paths:
    - stdout
  error-output-paths:
    - stderr
  enable-caller: true
  enable-stacktrace: false
  development: false

# Milvus configuration
milvus:
  # Milvus server address
  address: "${MILVUS_URL}"
  # Database name
  database: "default"
  # Username (leave empty if no auth)
  username: "${MILVUS_USER}"
  # Password (leave empty if no auth)
  password: "${MILVUS_PASSWORD}"
  # Connection timeout
  timeout: 30s
  # Connection pool size
  pool-size: 10

# Embedding provider configuration
# 支持的供应商: ollama, openai
embedding:
  # Provider name
  provider: "ollama"
  # API base URL
  base-url: "http://localhost:11434"
  # API key (required for openai)
  api-key: ""
  # Embedding model name
  # Ollama options: nomic-embed-text (768d), all-minilm (384d), mxbai-embed-large (1024d)
  # OpenAI options: text-embedding-3-small (1536d), text-embedding-3-large (3072d), text-embedding-ada-002 (1536d)
  model: "nomic-embed-text"
  # Request timeout
  timeout: 120s
  # Max retries for failed requests
  max-retries: 3

# Chat provider configuration
# 支持的供应商: ollama, openai
chat:
  # Provider name
  provider: "deepseek"
  # API base URL
  base-url: "https://api.deepseek.com"
  # API key (required for openai)
  api-key: "${DEEPSEEK_API_KEY}"
  # Chat model name
  # Ollama options: deepseek-r1:7b, deepseek-coder, llama3.2, qwen2.5
  # OpenAI options: gpt-4o, gpt-4o-mini, gpt-4-turbo, gpt-3.5-turbo
  model: "deepseek-chat"
  # Request timeout (longer for LLM generation)
  timeout: 120s
  # Max retries for failed requests
  max-retries: 3

# RAG-specific configuration
rag:
  # Size of text chunks (in characters)
  chunk-size: 512
  # Overlap between chunks
  chunk-overlap: 50
  # Number of results from similarity search
  top-k: 5
  # Milvus collection name
  collection: "milvus_docs"
  # Embedding vector dimension (must match embedding model)
  # nomic-embed-text: 768, all-minilm: 384, mxbai-embed-large: 1024
  # text-embedding-3-small: 1536, text-embedding-3-large: 3072
  embedding-dim: 768
  # Directory for storing downloaded documents
  data-dir: "_output/rag-data"
  # Query enhancement configuration
  enhancer:
    # Disable query rewriting to save time (~4 seconds)
    enable-query-rewrite: false
    # Disable HyDE (Hypothetical Document Embeddings)
    enable-hyde: false
    # Disable reranking to save time
    enable-rerank: false
    # Disable repacking
    enable-repacking: false
    # Rerank top K (only used if rerank is enabled)
    rerank-top-k: 10
  # System prompt template for RAG queries
  system-prompt: |
    You are a helpful assistant that answers questions based on the provided context.
    Use the following context to answer the question. If you cannot find the answer in the context, say so.
    Always cite the source documents when providing information.

    Context:
    {{context}}

    Question: {{question}}

    Answer:

# Cache configuration
cache:
  # Enable query result caching
  enabled: true
  # Cache TTL (time to live)
  ttl: 1h
  # Cache key prefix
  key-prefix: "rag:query:"
  # Redis configuration
  redis:
    # Redis host
    # 通过环境变量设置: RAG_CACHE_REDIS_HOST
    host: "localhost"
    # Redis port
    port: 6379
    # Redis password (leave empty if no auth)
    # ⚠️ 安全警告：绝对不要在此文件中硬编码密码！
    # 必须通过环境变量设置: RAG_CACHE_REDIS_PASSWORD
    password: ""
    # Redis database number
    database: 0
    # Max retries
    max-retries: 3
    # Connection pool size
    pool-size: 10
    # Minimum idle connections
    min-idle-conns: 5
