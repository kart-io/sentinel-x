# Sentinel-X API Server Configuration
# This is an example configuration file for the API server

# Server configuration
server:
  # Server mode: http, grpc, or both
  mode: both
  # Graceful shutdown timeout
  shutdown-timeout: 30s

  # HTTP server configuration
  http:
    # Listen address
    addr: ":8080"
    # Read timeout
    read-timeout: 30s
    # Write timeout
    write-timeout: 30s
    # Idle timeout
    idle-timeout: 60s
    # HTTP framework adapter: gin or echo
    adapter: gin

    # Middleware configuration
    middleware:
      # 启用的中间件列表（设置后会覆盖 disable-* 配置）
      # 支持的值: recovery, request-id, logger, cors, timeout, health, metrics, pprof, auth, authz
      enabled:
        - recovery
        - request-id
        - logger
        - cors
        - timeout
        - health
        - metrics
        - auth
        - authz
        # pprof 禁用（安全考虑，需要时手动启用）

      # 各中间件详细配置
      recovery:
        enable-stack-trace: false

      request-id:
        header: X-Request-ID

      logger:
        skip-paths:
          - /health
          - /live
          - /ready
          - /metrics
        use-structured-logger: true

      cors:
        # ⚠️ 安全警告：生产环境必须配置具体域名！
        allow-origins:
          - "*"  # TODO: 生产环境替换为具体域名
        allow-methods:
          - GET
          - POST
          - PUT
          - PATCH
          - DELETE
          - HEAD
          - OPTIONS
        allow-headers:
          - Origin
          - Content-Type
          - Accept
          - Authorization
          - X-Request-ID
        allow-credentials: false
        max-age: 86400

      timeout:
        timeout: 30s
        skip-paths:
          - /health
          - /live
          - /ready
          - /metrics

      health:
        path: /health
        liveness-path: /live
        readiness-path: /ready

      metrics:
        path: /metrics
        namespace: sentinel
        subsystem: api

      pprof:
        prefix: /debug/pprof
        enable-cmdline: true
        enable-profile: true
        enable-symbol: true
        enable-trace: true
        block-profile-rate: 0
        mutex-profile-fraction: 0

      auth:
        # Token lookup location
        # Format: "header:<name>" or "query:<name>" or "cookie:<name>"
        token-lookup: "header:Authorization"
        # Authorization scheme
        auth-scheme: "Bearer"
        # Paths to skip authentication (exact match)
        skip-paths:
          - /api/v1/auth/login
          - /api/v1/auth/register
          - /api/v1/hello
          - /health
          - /live
          - /ready
          - /metrics
        # Path prefixes to skip authentication
        skip-path-prefixes:
          - /api/v1/public/

  # gRPC server configuration
  grpc:
    # Listen address
    addr: ":8100"
    # Timeout
    timeout: 30s
    # Max receive message size (bytes)
    max-recv-msg-size: 4194304
    # Max send message size (bytes)
    max-send-msg-size: 4194304
    # Enable gRPC reflection
    enable-reflection: true

# Logger configuration
log:
  # Log level: debug, info, warn, error, fatal
  level: info
  # Log format: json, text
  format: json
  # Log output paths
  output-paths:
    - stdout
  # Error output paths
  error-output-paths:
    - stderr
  # Enable caller information
  enable-caller: true
  # Enable stacktrace for error level and above
  enable-stacktrace: false
  # Development mode (pretty print for text format)
  development: false

# JWT authentication configuration
jwt:
  # Disable authentication (set to true for development without auth)
  disable-auth: false
  # Secret key for signing tokens (min 64 characters for HMAC algorithms)
  # 必须与 user-center 使用相同的密钥！
  # 生产环境必须通过环境变量设置: SENTINEL_API_JWT_KEY
  key: "your-super-secret-key-change-in-production-minimum-64-characters-required-here"
  # Signing algorithm
  signing-method: "HS256"
  # Token issuer
  issuer: "sentinel-x"
  # Token expiration duration
  expired: 2h
  # Maximum refresh duration
  max-refresh: 24h

# MySQL database configuration
mysql:
  # Database host
  # 通过环境变量设置: SENTINEL_API_MYSQL_HOST
  host: "localhost"
  # Database port
  port: 3306
  # Database username
  # 通过环境变量设置: SENTINEL_API_MYSQL_USERNAME
  username: "root"
  # Database password
  # 必须通过环境变量设置: SENTINEL_API_MYSQL_PASSWORD
  # 不要在配置文件中硬编码密码！
  password: "root123"
  # Database name
  # 通过环境变量设置: SENTINEL_API_MYSQL_DATABASE
  database: "agent_manager"
  # Maximum idle connections
  max-idle-connections: 10
  # Maximum open connections
  max-open-connections: 100
  # Connection maximum lifetime
  max-connection-life-time: 3600s

# Redis configuration
redis:
  # Redis host
  # 通过环境变量设置: SENTINEL_API_REDIS_HOST
  host: "localhost"
  # Redis port
  port: 6379
  # Redis password (leave empty if no password)
  # 必须通过环境变量设置: SENTINEL_API_REDIS_PASSWORD
  # 不要在配置文件中硬编码密码！
  password: "redis_pass"
  # Redis database number
  database: 0
  # Maximum retries
  max-retries: 3
  # Connection pool size
  pool-size: 10
  # Minimum idle connections
  min-idle-conns: 5

# 顶层中间件配置（可选，会覆盖 server.http.middleware 中的对应配置）
# Middleware configuration
metrics:
  path: /metrics
  namespace: sentinel
  subsystem: api

health:
  path: /health
  liveness-path: /live
  readiness-path: /ready

pprof:
  prefix: /debug/pprof
  enable-cmdline: true
  enable-profile: true
  enable-symbol: true
  enable-trace: true

recovery:
  enable-stack-trace: false

logger:
  skip-paths:
    - /health
    - /live
    - /ready
    - /metrics
  use-structured-logger: true

cors:
  allow-origins:
    - "*"
  allow-methods:
    - GET
    - POST
    - PUT
    - PATCH
    - DELETE
    - HEAD
    - OPTIONS
  allow-headers:
    - Origin
    - Content-Type
    - Accept
    - Authorization
    - X-Request-ID
  allow-credentials: false
  max-age: 86400

timeout:
  timeout: 30s
  skip-paths:
    - /health
    - /live
    - /ready
    - /metrics

request-id:
  header: X-Request-ID
